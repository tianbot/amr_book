# 1.4 开发移动机器人的工具

### 1.4 研发移动机器人，应该使用什么工具？

如果我们现在想研发移动机器人，我强烈的推荐大家使用ROS（机器人操作系统）。其实我们平常接触到的操作系统寥寥无几，Windows，MacOS，Linux，iOS，Andoird。ROS虽然全名是Robot Operating System，但本质上不是操作系统，是Linux发行版Ubuntu下的一个用来开发机器人的Middleware。Android虽然意思是人形机器人，但这就只是个名字，Andy Rubin（安卓平台创始人）并不会真的想让开发者通过智能手机探秘智能机器人。

对于机器人上位机的运行环境，我们总是关心系统的实时性是否必须。简单的说，如果在系统中Δt是关键变量，系统就需要实时，例如双足机器人动态行走系统就必须实时，但是静态行走的话其实不实时也可以。如果实时性是必须的，我们可以选择Windows + VxWorks，这是在传统运动控制领域非常常见的一个组合。也可以选择QNX操作系统，或者LabView。笔者最早接触的实时操作系统是Windows + Ardence RTX，后来应该改名为IntervalZero。即便是需要实时，架构也是很灵活的，对于移动机器人来说，上位机并没有实时性的强需求。

当我们需要提高机器人复杂度的时候，就会发现另一个问题，进程间通信。之前使用Windows + RTX的时候，进程间通信可以利用RTX提供的shared memory进行，不过都是比较慢的图像处理进程向shared memory中写数据，决策和运动控制进程读数据。Shared memory有非常快的交换速度，也很适合实时系统，但是也有延展性不好和性能极限较低的缺陷。ROS的进程间通信是利用网络消息通信架构，并且是ROS整个框架的一个基础（不论是对于ROS中的topic，service，plugin，actionlib等基础概念还是rviz，navigation package等功能包）。不过很多人简单的理解ROS只不过是做了一个通信的架构，这种看法有失偏颇，因为进程间通信并不是ROS能够占领机器人开发环境的主要原因。在2010年，我们开发一款类似Atlas的大型人形军用机器人的时候，就用到了进程间通信工具IPC\[2]。IPC全称Inter Process Communication，是由CMU的Reid Simmons教授设计。最早是为NASA的项目开发于1994年，而最新版发布于2014年，一直也在开发维护。之后笔者在协助RoboCup 参赛队伍的时候学习使用过NAO机器人，这个机器人发布于2006年，在2008年就替代SONY的Aibo机器狗成为Standard Platform League的比赛平台。NAO的操作系统NAOqi整个通信的架构也是非常类似ROS，ROS中的Node（节点）在NAOqi中叫一个Broker，都是占用一个系统的端口。所以，2010年ROS正式发布Box turtle的时候，可以认为ROS也是使用了当时主流的机器人开发的通讯架构做进程间通信。经过十多年的发展，ROS的通信机制放到现在已经有点过时了，ROS 2.0就已经换掉了整个通讯机制。再有，ROS中的通信机制并不是说不能绕过，我们自己在开发时就写过socket和pika，因为其程序本质上还是C++和Python。

ROS最大的贡献在笔者看来就是制定了机器人开发的统一接口标准。因为Willow Garage当年是开发移动服务机器人，所以这些标准是首先在移动机器人领域统一的。ROS的意义，可以概括为六个字，“**车同轨，书同文**”，极大加速了交流与进步。也是因为这样，机器人学界才慢慢能够形成一些评定标准，能够在开源社区形成百花齐放的态势，能够让大家不再深陷于又要搭建硬件又要搭建软件的重复造轮子的困境。实际上就是ROS所定义的各种消息类型（Message Type），看起来不过是一些头文件，但是可以让我们轻松的替换各种传感器和执行机构，替换软件中的各个算法，把搭建机器人这件事情变得像玩乐高积木或者组装一台电脑一样简单。

不过用于开发机器人，ROS的优势不仅仅是拥有统一接口，还有很好的可视化、模拟仿真和Debug的工具。经验丰富的机器人工程师更加对这些工具带来的便捷性有切身体会。可视化的工具RViz，就像通信工程师用的示波器，像电气工程师用的万用表，如果没有RViz这种可视化工具，机器人复杂功能的开发测试寸步难行。ROS下的模拟仿真做到了和硬件的无缝衔接（这点LabView也做的很好，产品化的体验更好），以前我们都是用Matlab，ODE（Open Dynamics Engine）自己写模拟仿真，但是随着ROS中开源的Gazebo出来后，发展速度远远超过了V-REP和Webots，竟然还引发了Webots开源。还有在机器人开发过程中，Debug与纯软件在IDE（Integrated Development Environment集成开发环境）中开发调试区别很大，ROS提供的log和rosbag以及动态调参的方法，极大提高了调试效率，用过就爱不释手了。拥有这些工具，ROS从专业上讲对开发者及其友好，这也是很多人解释ROS适合学习和研发机器人的原因。但同时因为开源以及周边工具复杂又带来了更多的不稳定性，不过ROS开发的产品，尤其在产品成型后，基本用不到这些调试工具，现阶段来看是可以满足产品的稳定性要求的，市面上也可以见多很多基于ROS开发的移动机器人商业产品。

最后，就要说说基因，社区，支持和人才的问题。针对机器人开发，ROS的基因是移动式服务机器人，LabView的基因是NI，Android的基因是Google和智能手机。ROS是完全开源的，其核心代码选择了对商业化非常友好的BSD（Berkeley Software Distribution）开源协议，而其他工具比如老牌开发工具LabView上手简单技术支持到位，但是闭源和价格会让很多人望而却步；Microsoft Robotics Developer Studio也是个不错的开发工具，虽然流行了一段时间但很快就销声匿迹。ROS社区在机器人开发者中的活跃度就相当高了，整体开发者数量估计在十万的量级（ROS answer注册用户截至2021年末达到4万人\[3]）。

最后，我们来讨论下ROS在整个机器人行业中的现状。就机器人的设备数量和开发者数量来说，ROS完全无法和如日中天的智能手机操作系统Android相比。硅谷的机器人创业公司基于ROS开发的比较多（相对国内而言，具体比例不清楚，从RosCon的支持厂商就能看到一些端倪），但是国内用Android开发的机器人公司明显在数量上占据上风，即使这两年ROS取得了长足的发展，在绝对数量上还是差距很大。不讨论工业机器人（以及类工业机器人的医疗机器人等，以控制为核心），我们更加细致的划分下其他的机器人品类。首先，教育机器人（这里指机器人的教育套件等，不是说用来学习英文或者唐诗的对话机器人，这个归属到情感陪护类），主要面向k-12的学生，也就是我国高等教育之前的学生，大多就是Scratch图形化编程加上单片机，并没有复杂到需要操作系统。这种情况可能会在不久的未来发生改变，主要是教育机器人业内已经有人发现机器人教育和机器人开发的脱节是个问题，很多推动机器人教学的比赛已经开始重视ROS，比如RoboMaster和RoboCon，并且会慢慢向低年龄阶段拓展。还有玩具类、创客类机器人也是类似的，并不需要操作系统，这些品类也不可能支撑革命性的机器人技术。而消费级服务机器人，主要以儿童陪护机器人为主，也是学界大热的Social Robot（社交机器人）领域，在2014年以后在我国的发展速度超出超出想象。虽然整体上机器人的智能无法支撑情感陪护这个概念，但是借助智能手机的发展，尤其是现在集成了大量传感器的智能手机，使Android系统对硬件比如摄像头，IMU，麦克风，通讯元件等等支持很好；其次，一直在致力于改变人机交互方式的巨头们做出了很多惊人的贡献，触屏交互和语音对话都取得突破性进展；再有，因为Android系统的一些附属产品的发展，Android平板，智能家居产品，故事机，儿童手表等，使得儿童陪护机器人整个产业链从硬件到内容都非常完善，从产业的角度造就了儿童情感陪护类的机器人爆发。如果从需求和市场上来讲，老年陪护类的机器人才应该是未来更大的蛋糕。无论如何，情感陪护机器人，现阶段Android是占据统治地位的。

但是，若要从事机器人行业，跟随机器人行业爆发，把机器人作为一生的事业，用Android怕是不够的。首先，由于Android的基因，我们发现情感陪护机器人的大多功能都是手机和平板能够实现的，虽然集成了更多的传感器，但是对于实现复杂的功能上和ROS相比后劲不足，也导致产品同质化比较明显。第二，情感陪护类机器人这两年增长确实很快，算在机器人行业里是非常大的体量，但是如果算在Android的阵营呢？机器人行业整体很小，中国服务机器人市场2018年约为18.4亿美元，而华为2018年消费者业务网站的报道称其当年手机销量就超过2亿部\[4]。所以，作为Anroid的衍生品，情感陪护类机器人在这个存量市场的份额并不大。 而面向行业的服务机器人，在未来会迎来爆发。做酒店运送机器人的Savioke和云迹科技，做移动抓取的Fetch Robotics，做移动机器人底层核心技术的思岚科技，应该很多做物流相关的机器人的公司，这些公司的共同点就是产品直接应用在第二和第三产业，目标都是直接推动生产力，如果真正降低成本，是毋庸置疑的刚性需求。这些机器人技术难度比较高，沿袭了机器人学的发展，用ROS开发有很大的优势。

对机器人产业来说，需要有精英的研究人员做出技术突破，需要有足够数量的开发人员做场景落地。对于机器人开发人员来说，不仅仅要选择合适的开发的系统和环境，还需要掌握机器人运作的原理和工程体系，即使未来最主流的机器人操作系统不是ROS，一定会有ROS深深的烙印。
