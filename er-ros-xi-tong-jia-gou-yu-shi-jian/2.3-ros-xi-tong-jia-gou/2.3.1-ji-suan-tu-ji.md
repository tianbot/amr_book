# 2.3.1 计算图级

计算图级：节点、消息、服务、节点管理器、话题和消息记录等。

图 2‑8 计算图级框架

**节点（Node）**

节点是计算机执行计算任务的进程。每个节点占据系统中的一个网络端口，因此在ROS的架构下节点与节点可以通过网络进行通信。一个系统一般由多个节点组成，可以称其为“软件模块”。节点概念的引入使得基于ROS的系统在运行时更加形象，当许多节点同时运行时，可以很方便地将端到端的通讯绘制成一个图表，在这个图表中，进程就是图中的节点，而端对端的连接关系就是其中弧线连接。系统中的每个节点都要有一定的功能，但是功能过多会增加耦合度降低复用性，功能单一会导致整体架构复杂并且通讯消息太多降低性能。所以ROS开发过程中合理设置节点功能非常重要，这非常需要经验。

rosnode是一个用于显示节点信息的命令行的工具，例如当前正在运行的节点。

* $ rosnode info \<node name> 输出节点的信息。
* $ rosnode kill \<node name> 结束运行中的节点。
* $ rosnode cleanup 将无法访问节点注册信息清除。
* $ rosnode list 列出当前运行的节点。
* $ rosnode machine hostname 显示计算机上运行的节点，或者列出主机名称。
* $ rosnode ping \<node name> 测试节点间的连通性。

**节点管理器（Master）**

ROS Master一般翻译为节点管理器，但是更多中文用户还是喜欢直呼ROS Master英文名。之所以称之为节点管理器，是因为ROS对节点是中心化的管理方式，节点在启动时需要在节点管理器上进行注册并通过节点管理器与其他节点握手后进行通信。如果我们的系统中没有ROS节点管理器，那么节点之间的话题与服务等通信就不能建立。由于ROS本身就是一个分布式网络系统，只需要在某一台“服务器”上运行节点管理器，节点则可以按照需求，不论运行在本机还是其他计算机上均可以。

**参数服务器（Parameter Server）**

属于节点管理器的一部分，将数据存放在系统关键位置，节点可以获取这些数据来配置、改变自己的状态。

rosparam工具用于从命令行获取和设置ROS参数。 以下是参数操作的相关命令：

* $ rosparam set \<parameter name> \<value>：设定参数值
* $ rosparam get \<parameter name>：获取一个参数值
* $ rosparam load \<YAML file>：使用此命令将保存在YAML文件中的参数加载到参数服务器
* $ rosparam dump \<YAML file>：此命令将将现有ROS参数转储到YAML文件
* $ rosparam delete \<parameter name>：此命令将删除给定的参数
* $ rosparam list：此命令将列出现有参数名称

**消息（Message）**

节点间沟通传输的信息数据，节点只有通过消息才能完成彼此的沟通。ROS中存在多种标准类型的消息，我们还可以开发自定义类型的消息，前提是基于标准消息。

一个节点要想将数据发送到另一个节点，需要通过话题发送消息。消息具有一定的类型，包括ROS提供的标准类型和用户自定义类型。

ROS使用命令行工具rosmsg来获取有关消息的信息。其常见的支持命令如下：

* $ rosmsg show \<message type>显示消息类型的字段。
* $ rosmsg list 列出所有消息。
* $ rosmsg package \<package name>列出功能包的所有消息。
* $ rosmsg packages 列出所有包含有消息定义的功能包。
* $ rosmsg md5 显示消息的md5校验码。

**话题（Topic）**

在消息发送的过程中，每一条消息都要发布到相应话题，当一个节点发送数据时，我们就说该节点正在向话题发布消息。简单来说消息以一种发布/订阅的方式传递，平常的情况是一个节点向话题发布消息，另一个节点可以向话题订阅消息，是通信常用的生产者消费者模式。在ROS中，可以多个节点向同一个话题发送消息，也可以多个节点从一个话题订阅消息。整个ROS中的通信是非常灵活的，但这种情况就要注意消息传递的路径是否符合设计的逻辑。话题多用于传输传感器信息、发布控制信号等持续进行的过程。

话题作为节点用来传输数据的总线，因为采用了生产者消费者模式，虽然是点对点通信，但是中间有阻塞队列，发布者与订阅者并不是强耦合的直接连接。这就意味着发布者和订阅者之间并不需要知道彼此是否在线，是否建立了连接。不论是发布还是订阅话题，都需要指定话题上进行的消息类型，这样节点接收同类型的消息才能够解析。

ROS有一个关于rostopic工具用于话题操作，它是一个命令行工具，允许获取有关话题的相关信息。

* $ rostopic bw < topic name> 显示话题所使用的带宽。
* $ rostopic echo \<topic name> 输出消息到屏幕上。
* $ rostopic find < message type > 按照类型查找话题。
* $ rostopic info \<topic name> 输出话题信息。包括话题中的消息类型、话题发布者和订阅者的信息。
* $ rostopic list 显示当前运行话题的列表。
* $ rostopic hz \<topic name> 显示话题的发布频率。
* $ rostopic pub \<topic name> \<message type> \[data] 将数据发布给话题。
* $ rostopic type \<topic name> 输出话题的类型。可以组合rosmsg命令使用。

**服务（Service）**

服务用于节点直接向节点交互，获得请求或应答。如果想要及时获得请求和应答时，若使用异步通信的话题有可能丢失消息，ROS中的服务（Service）可以有效地解决这个问题。与话题不同，ROS中只能有且只有一个节点提供某个名称的服务。

服务可以及时获取反馈信息的特点弥补了话题的不足。像话题一样，服务关联一个以功能包中.srv文件名称来命名的服务类型。

ROS关于服务的命令行工具有rossrv和rosservice。我们可以通过rossrv看到有关数据结构信息，并且与rosmsg具有完全类似的用法，这里不再赘述。Rosservice常见支持命令如下：

* $ rosservice call \<service name> 根据命令行参数调用服务。
* $ rosservice find \<service type> 根据服务类型查询服务。
* $ rosservice info \<service name> 输出服务信息。
* $ rosservice type \<service name> 输出服务类型。
* $ rosservice uri \<service name> 输出服务的ROSRPC URI，即服务所在的IP地址与端口。
* $ rosservice list 输出可用的服务清单。

**消息记录包（Bag）**

用于保存和回放消息数据。它能够获取并记录各种难以收集的传感器数据。我们可以通过消息记录包获取实验数据以反复进行播放，方便进行开发和算法测试。

消息记录包是由ROS创建的文件。它使用.bag文件去保存话题、消息等数据消息。在操作完成之后，使用可视化工具调用和回放数据，查看详细信息。其常见指令如下：

* $ rosbag record \<topic names> 用来录制包含指定话题名称的消息记录包。
* $ rosbag play \<bagfile name> 用来播放消息记录包。
* $ rosbag info \<bagfile name> 查看消息记录包的信息，包括起止时间，话题及消息类型，等等。
* $ rqt\_bag 用于可视化图形环境中的数据。
