# 2.4 ROS的通信方式

ROS采用的是松耦合分布式异步通信机制。ROS是一个分布式框架，为用户提供多节点之间的通信服务，通信机制是ROS的核心功能。ROS中所有的软件和工具都建立在这种分布式通信机制上，所以我们大家如果在开始深入研究ROS之前，必须掌握相关的基础。ROS的通信方式主要有三种，分别是：话题、服务和动作（action）；还有就是参数服务器，坐标变换（TF）也使用不同的通信方式。因为动作库（actionlib）和坐标变换后面有会详细介绍，下面简单总结了话题、服务和参数服务器这三种通信机制，重要的是这三种通信方式也是直接由ROS Master提供并管理的。

#### 话题通信机制

话题是ROS中最常使用的通信方式，动作库也是基于话题的通信方式。虽然建立通信后节点之间的话题通信是点对点的方式（Peer-to-peer），但是建立连接还是必须通过ROS Master进行握手。通信的底层可以使用TCP/IP或者UDP的方式，但是平常写程序时不必关心底层的通信方式。下面我们一起来看看通过话题通信时节点是如何建立连接的。如图 2‑11所示。

图 2‑11 话题通信机制模型

在图中有两个节点：一个是Talker，另一个是Listener。如果它们两个要建立联系，就需要两个节点分别发布、订阅同一个话题。下面是如图所示的两个节点建立连接的过程，注意其中ROS Master的作用。很多读者可能不清楚foo，bar这两个常见单词的意思，实际上这两个单词只是简单的指代，就像我们中文常说的张三李四。图中的foo代表主机名（hostname），bar则是话题名称。再有一个概念强调下，之前提到过每个节点占据一个端口号，就是指节点的XML-RPC URI（Uniform Resource Identifier，统一资源标识符）。

* Talker启动，首先要从系统环境变量得到ROS Master的地址（ROS\_MASTER\_URI），然后连接到ROS Master，将自己的XML-RPC URI地址和端口（foo:1234）在ROS Master上进行发布者的信息注册，包含所要发布的话题名称（bar）和消息类型；ROS Master会将该发布者的注册信息存储到发布者注册列表中，等待接收者。
* Listener启动，将其订阅的话题名bar和消息类型在ROS Master上注册（实际上也包括自己的地址和端口信息）。
* ROS Master根据Listener所需的订阅话题在发布者注册列表寻找与之匹配的话题，并返回发布此话题的发布者列表。这里只有Talker一个发布者，ROS Master就会向Listener发送Talker的XML-RPC地址信息，即foo:1234。
* Listener接收到Talker的地址，会向Talker发送连接的请求，告诉需要传输的话题名称bar，消息类型以及所使用的通信协议为TCP（通信情况不好时可以选择UDP）。
* Talker接受到Listener发来的连接请求后，会确认连接信息，主要是要通知Listener，话题传输时所使用的TCP地址信息为foo:2345。
* Listener接收到TCP地址信息后，就可以向Talker发起使用TCP协议连接传输数据的请求。
* 等连接成功后，Talker开始向Listener通过TCP协议发送话题消息数据。此时就成为点对点的连接方式，ROS Master协助双方握手的使命就完成了。

上述过程看起来复杂，实际逻辑还是很清晰明了的。我们常常将ROS Master比喻成婚姻中介，其作用就是为适龄的男女青年牵线搭桥。男女双方首先都要在中介处登记基本情况、择偶标准和联络方式。婚介会把合适的双方挑选出来，男方就可以根据女方的联络方式发出约会的请求。充分沟通后，男方和女方就可以进行点对点的通信而无需再经过婚介。上述Talker和Listener的通信过程也是类似的，理解到这一层面，在ROS的使用和开发上就没有问题了。而且ROS开发时不需要处理socket等基础网络层面，普通用户无需深入理解底层的通信原理。

后面我们在讲ROS实战的时候会解释到关于Talker和Listener的实际应用。

#### 服务通信机制

服务是一种带有应答的通信机制，通信原理如图 2‑12所示，Host提供服务，Client可以请求服务。从机制上看服务与话题的主要区别是服务没有通信协议的确认过程，主要原因是服务是一个请求/响应的过程，而UDP协议一般用于通信状况不佳的环境，不适用于服务，因此在ROS中服务的连接过程只有5个步骤，在ROS Master上注册服务时直接注册服务的TCP地址与端口即可。

在实际的应用中，话题常用于发布传感器数据、输出控制信号等持续传输的过程，而服务则常见于实现机器人状态切换的一些指令。服务的响应则可以反映命令是否成功执行，以及附加一些相关信息。如果需要机器人执行任务，服务也是无法完成的，就需要使用动作库（actionlib），因为执行任务需要时间，不仅要返回结果还要实时返回执行的状态。以外卖送餐为例，商家需要一直在app上发布菜品的信息，这就需要消息的模式；顾客可以下单，等待商家接单，需要立即确认，这就是服务的模式；商家会委派外卖骑手送餐，骑手送餐时会不断反馈位置，送餐结束需要确认成功，这就是动作库的模式。理解不同的通信方式背后的机制以及使用场景，可以极大的帮助刚接触ROS，需要进行机器人开发测试的入门者。

图 2‑12 服务通信机制模型

#### 参数管理机制

机器人的研发过程中，调参是一项非常重要的工作。我们常戏称一个机器人的表现优秀与否，三分靠算法，七分靠调参。ROS对于参数的管理有一套自己的机制，就是参数服务器。参数服务器实际上是ROS Master的一部分，但是从功能上比较独立。参数服务器有两种模式，一种就是简单的存储参数，在节点启动时向ROS Master请求；另一种就是调试时最常用的参数动态调节。。

存储参数时，节点可以通过XMLRPC在ROS Master上设置或者读取参数。也可以通过命令行、参数文件等多种形式对服务器上的参数进行修改。这样比我们将参数写在程序源文件中方便了很多，至少不需要每次修改参数就重新编译生成。程序主体不受参数影响就容易分发，适应不同平台。问题可能是节点启动时从ROS Master读取参数，只能够适用在运行过程中参数无需变化的情况。

动态调参的机制比较复杂，不仅需要在调用参数的节点中加入动态调参的服务器（server），还需要有单独的客户端进行参数修改或者使用rqt\_reconfigure图形界面进行修改。动态调参的优势也是无可取代的，就是可以在机器人运动过程中（On the fly）直接修改参数。在我们要调整比如PID控制，步态，导航等功能时，动态调参可以节省大量的时间。

#### 多机互联

因为ROS采用的分布式网络通信，用户就可以不必拘泥于设备的物理连接，从而可以实现硬件驱动和算法调试的分离，或者多机器人协作等需要多机互联的任务。在调试机器人的时候，往往不可能直接在机器人机载的上位机上进行图形化观察或调试，就需要远程接入。使用SSH可以实现命令行的操作，但是无法使用ROS中的图形化工具。虽然也有远程桌面VNC连接的方式，但是图像传输占用带宽大速率低，还会影响ROS内部的数据传输。下面我们讲解如何在机器人机载电脑（Robot）和程序员操作的电脑（PC）间的进行网络配置，实现基于ROS的多机互联。

不少用户因为没有完全明白ROS互联的机制而在实现互联时出现问题。多机互联首先需要保证通信双方能够在网络上互相发现，因此需要将PC和Robot接入同一个局域网。

在终端中输入如下命令查看PC的IP地址：

$ ifconfig

会如图 2‑13所示。这里的192.168.0.97是局域网地址（192.168.x.x是一般小型局域网的常用地址），而127.0.0.1是本地回环地址，等价于本地主机localhost。同样方式可以获得机器人电脑上的IP为192.168.0.48。然后可以输入以下命令查看主机名：

$ hostname

可以看到PC的主机名为ros2go，其实终端的标题栏上显示的tianbot@ros2go已经提示了主机名。

接下来需要设置环境变量使得PC和Robot能够互通。主要就是要注意两个环境变量，用于指定ROS Master地址的ROS\_MASTER\_URI，和指定本地地址的ROS\_IP。虽然使用ROS\_HOSTNAME可以替代ROS\_IP，但是因为需要配置Hosts文件以及DNS解析并不稳定，并不推荐使用\[11]。我们需要将这两个环境变量加入.bashrc文件中。

图 2‑13 网络配置详情

图 2‑14 Robot端的.bashrc文件多机互联相关设置

我们在PC端和Robot端都需要设置上面提到的两个环境变量。一般我们会把ROS Master设置在机器人Robot上作为主机，需要在其.bashrc文件增加设置，如图 2‑14所示。

保存后需要执行如下命令重新读入.bashrc文件使得修改部分可以生效：

$ source .bashrc

PC端的设置也基本如上，在.bashrc中底部加入如下设置：

export ROS\_MASTER\_URI = http://192.168.0.48:11311

export ROS\_IP=192.168.0.97

以Robot的设置为例，因为ROS Master在本机执行，ROS\_MASTER\_URI可以写为localhost，也就是127.0.0.1，当然指定为192.168.0.48的本机局域网地址也可以。需要注意的是，虽然单机执行时并不需要设置ROS\_IP， 但是多机互联时在机器人Robot的主机上必须设置ROS\_IP为192.168.0.48。这也是多机互联最容易出错的地方。错误的现象就是从机PC可以通过rostopic list命令向ROS Master请求所有话题的列表，但是使用rostopic echo却无法订阅到主机节点发送的消息内容。回顾一下上面的话题通信机制就能够发现，在使用多机通信时，主机上的节点启动需要上报XML-RPC地址，即ROS\_IP与端口号，如果未定义或写成localhost，ROS Master就会发送空的ROS\_IP或者localhost给从机，那么从机请求订阅的时候就无法与通过XML-RPC与主机的节点连接，更无法建立后续的TCP连接。

多机互联设置完成后，信息就可以在多台机器之间流动，我们可以将不同的节点放置在不同的主机上运行。但是要注意机器人的硬件驱动还是要在与机器人连接的机载主机上运行，图形界面一定要在有显示设备的电脑上运行。一般我们将roscore放在机器人平台上，在我们自己的PC上使用rviz、rqt去观察传感器信息以及进行动态参数的调整。
